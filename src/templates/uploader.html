<!-- Third party script for BrowserPlus runtime (Google Gears included in Gears runtime now) -->    
<script type="text/javascript" src="http://bp.yahooapis.com/2.4.21/browserplus-min.js"></script>

<!-- Load plupload and all it's runtimes and finally the jQuery queue widget -->

<script type="text/javascript" src="/static/plupload/plupload.full.js"></script>
<script type="text/javascript" src="/static/plupload/i18n/ru.js"></script>


<script type="text/javascript">
// Custom example logic
$(function() {
    var uploader = new plupload.Uploader({
        runtimes : 'gears,html5,flash,silverlight,browserplus',
        browse_button : 'uploadAdd',
        container : 'upload',
        max_file_size : '10mb',
        url : '/upload',
        flash_swf_url : '/static/plupload/plupload.flash.swf',
        silverlight_xap_url : '/static/plupload/plupload.silverlight.xap',
        filters : [
        {title : "Image files", extensions : "jpg,jpeg,gif,png"}
        ],
        resize : {width : 320, height : 240, quality : 90}
    });

    uploader.remove = function(file_name) {
        $("li[file-name='" + file_name + "']").remove();
        var fileId = $(this).attr("file-id");
        var file = uploader.getFile(fileId);
        if(file) {
         uploader.removeFile(file);
     }
 };

 uploader.add = function(file_name, file_id) {
        $("li[file-id='" + file_id + "']").remove();
        $(".upload-add").before("<li class='span3' file-name='" + file_name + "'> <a class='thumbnail preview'> <img  file-name='" + file_name + "' src='/photo/" + file_name + "'/> <i title='Удалить' class='icon-remove-sign' file-name='" + file_name + "'></i></a> </li>");

        //remove uploaded photo
        $("i[file-name='" + file_name + "']").bind("click", function(){
            uploader.remove(file_name);});
        return false;
    };

    uploader.bind('Init', function(up, params) { 
        var photos = $("#photos").val();
        if(photos) {
            $.each(photos.split(","), function(i, file_name) {
                up.add(file_name, "");
            });
        }
    });

    /*$('#uploadfiles').click(function(e) {
        uploader.start();
        e.preventDefault();
    });*/

uploader.init();

uploader.bind('FilesAdded', function(up, files) {
    $.each(files, function(i, file) {
        $(".upload-add").before("<li class='span3' file-id='" +  file.id + "'><div class='thumbnail preview'><img src='/static/img/ajax-loader.gif' alt='Фотография загружается'/></div></li>")
    });
    uploader.start();
        up.refresh(); // Reposition Flash/Silverlight
    });

uploader.bind('UploadProgress', function(up, file) {
        //alert(file.percent);
        //$('#' + file.id + " b").html(file.percent + "%");
    });

uploader.bind('Error', function(up, err) {
    alert("Произошла ошибка. Попробуйте загрузить файл еще раз.");
        up.refresh(); // Reposition Flash/Silverlight
    });

uploader.bind('FilesRemoved', function(up, files) {
});

uploader.bind('FileUploaded', function(up, file, response) {
        //$('#' + file.id + " b").html("100%");
        file_name = response.response;
        up.add(file_name, file.id);
    });

});

</script>



<div class="input upload-files" id="upload">
  {#<p>
      <a id="uploadAdd" class="btn btn-mini" href="#" title="Добавить фото">
          <i class="icon-plus"></i>&nbsp;Добавить ...&nbsp;</a>
      </p>#}

      <ul class="thumbnails" id="uploadFiles">
            <li class="span3 upload-add"> 

            <a id="uploadAdd" href="" class="thumbnail"><img data-src='/static/js/holder.js/160x120/text:Добавить фото'> 
            </a>
            </li>
        </ul>
    </div>
    

